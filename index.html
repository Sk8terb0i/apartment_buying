<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apartment Purchase Tracker</title>
  <style>
    :root{--card-bg:#ffffff;--muted:#666;--accent:#4caf50}
    body{font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7fb;margin:0;padding:24px;display:flex;justify-content:center}
    .app{max-width:820px;width:100%}
    h1{margin:0 0 8px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .items{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:var(--card-bg);border-radius:10px;padding:14px;border:1px solid #e6e8ee;box-shadow:0 1px 2px rgba(16,24,40,0.03)}
    .item-head{display:flex;justify-content:space-between;align-items:center}
    .item-name{font-weight:600}
    .names{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
    .name{padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#111;font-size:14px}
    .name.current{background:linear-gradient(90deg,#dff7e0,#c3f3c3);box-shadow:0 2px 6px rgba(76,175,80,0.12);font-weight:700}
    button.chk{background:linear-gradient(90deg,var(--accent),#2e8b57);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .meta{color:var(--muted);font-size:13px}

    /* horse celebration */
    .horse-wrap{position:fixed;left:0;top:0;right:0;bottom:0;pointer-events:none;overflow:hidden}
    .horse{position:absolute;font-size:42px;transform:translateX(-120%);animation:run 1500ms linear forwards}
    @keyframes run{0%{transform:translateX(-120%) translateY(0) rotate(0)}25%{transform:translateX(10%) translateY(-6px) rotate(-2deg)}50%{transform:translateX(50%) translateY(0) rotate(2deg)}75%{transform:translateX(90%) translateY(-6px) rotate(-1deg)}100%{transform:translateX(120%) translateY(0) rotate(0)}}

    .confetti{position:absolute;left:50%;top:20%;width:12px;height:12px;opacity:0;animation:pop 800ms ease forwards}
    @keyframes pop{0%{opacity:1;transform:translate(-50%,-20px) scale(0.6)}100%{opacity:1;transform:translate(calc(-50% + var(--x)),calc(-20px + var(--y))) scale(1)}}

    .small{font-size:13px;color:var(--muted)}

    footer{margin-top:18px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="app">
    <h1>Apartment Purchase Tracker</h1>
    <p class="lead">The <strong>highlighted person</strong> is the one who needs to buy the item next. Click "Mark as bought" when they buy it.</p>

    <div id="items" class="items"></div>
  </div>

  <div id="celebration" class="horse-wrap" aria-hidden="true"></div>

  <script>
    // ----- CONFIG -----
    const API_BASE = 'https://script.google.com/macros/s/AKfycbzJORL2iiPCQFQ1jWUU0E3wlGBcrxUUy6WMsSisVvPpvbamAc60_cUigBkuBYd7MC5x/exec';
    // ------------------

    async function apiGet() {
      const res = await fetch(API_BASE);
      if (!res.ok) throw new Error('Failed to load from sheet');
      return res.json();
    }

    async function apiPost(itemName, newIndex) {
      const res = await fetch(API_BASE, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({item: itemName, index: newIndex})
      });
      if (!res.ok) throw new Error('Failed to save to sheet');
      return res.json();
    }

    function el(tag, props={}, ...children){
      const n = document.createElement(tag);
      for (const k in props) {
        if (k === 'class') n.className = props[k];
        else if (k.startsWith('on')) n.addEventListener(k.slice(2), props[k]);
        else n.setAttribute(k, props[k]);
      }
      for (const c of children) if (c) n.append(typeof c === 'string' ? document.createTextNode(c) : c);
      return n;
    }

    function playHorseSound(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'square';
        o.frequency.setValueAtTime(440, ctx.currentTime);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime + 0.01);
        o.connect(g); g.connect(ctx.destination);
        o.start();
        o.frequency.exponentialRampToValueAtTime(660, ctx.currentTime + 0.14);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.5);
        o.stop(ctx.currentTime + 0.55);
      }catch(e){/* audio blocked or unavailable */}
    }

    function celebrate() {
      const wrap = document.getElementById('celebration');
      // horse
      const horse = el('div',{class:'horse'}, 'üêé');
      horse.style.top = (20 + Math.random()*60) + '%';
      wrap.appendChild(horse);

      // confetti bits
      for(let i=0;i<18;i++){
        const c = el('div',{class:'confetti'});
        c.style.setProperty('--x', (Math.random()*240 - 120) + 'px');
        c.style.setProperty('--y', (-200 + Math.random()*300) + 'px');
        c.style.left = (50 + Math.random()*10 -5) + '%';
        c.style.background = ['#f43f5e','#fb923c','#facc15','#10b981','#60a5fa'][Math.floor(Math.random()*5)];
        c.style.borderRadius = (Math.random()*50)+'%';
        c.style.width = (6 + Math.random()*10) + 'px';
        c.style.height = (6 + Math.random()*10) + 'px';
        wrap.appendChild(c);
        // remove later
        setTimeout(()=>c.remove(),900);
      }

      playHorseSound();
      setTimeout(()=>horse.remove(),1600);
    }

    // Render
    async function loadAndRender(){
      const container = document.getElementById('items');
      container.innerHTML = '';
      let items;
      try{ items = await apiGet(); }catch(e){ container.appendChild(el('div',{class:'card'}, el('div',{}, 'Could not load data ‚Äî check your Apps Script deployment.'))); return }

      items.forEach(it => {
        const card = el('div',{class:'card'});
        const head = el('div',{class:'item-head'}, el('div',{class:'item-name'}, it.item));

        const cycle = Array.isArray(it.cycle) ? it.cycle : (typeof it.cycle === 'string' ? it.cycle.split(',') : []);
        const idx = Number(it.index) || 0;

        const namesRow = el('div',{class:'names'});
        cycle.forEach((n,i)=>{
          const cls = 'name' + (i===idx ? ' current' : '');
          namesRow.appendChild(el('div',{class:cls}, n));
        });

        const btn = el('button',{class:'chk', onclick: async ()=>{
          // optimistic UI update
          const next = (idx + 1) % cycle.length;
          // disable during save
          btn.disabled = true; btn.textContent = 'Saving...';
          try{
            await apiPost(it.item, next);
            celebrate();
            // small delay so celebration visible then reload
            setTimeout(loadAndRender, 600);
          }catch(err){
            alert('Save failed ‚Äî try again.');
            btn.disabled = false; btn.textContent = 'Mark as bought';
          }
        }}, 'Mark as bought');

        const meta = el('div',{class:'meta small'}, 'Next buyer: ' + (cycle[idx] || '‚Äî'));

        head.appendChild(el('div',{}, btn));
        card.appendChild(head);
        card.appendChild(namesRow);
        card.appendChild(meta);

        container.appendChild(card);
      });

    }

    // initial load
    loadAndRender();

    // optional: poll for updates every 12s so multiple users see updates quickly
    setInterval(loadAndRender, 12000);
  </script>
</body>
</html>
