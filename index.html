<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Apartment Purchase Tracker</title>
  <style>
    :root{--card-bg:#ffffff;--muted:#666;--accent:#4caf50}
    body{font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7fb;margin:0;padding:24px;display:flex;justify-content:center}
    .app{max-width:820px;width:100%}
    h1{margin:0 0 8px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .items{display:grid;grid-template-columns:1fr;gap:12px}
    .card{background:var(--card-bg);border-radius:10px;padding:14px;border:1px solid #e6e8ee;box-shadow:0 1px 2px rgba(16,24,40,0.03)}
    .item-head{display:flex;justify-content:space-between;align-items:center}
    .item-name{font-weight:600}
    .names{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
    .name{padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#111;font-size:14px}
    .name.current{background:linear-gradient(90deg,#dff7e0,#c3f3c3);box-shadow:0 2px 6px rgba(76,175,80,0.12);font-weight:700}
    button.chk{background:linear-gradient(90deg,var(--accent),#2e8b57);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .meta{color:var(--muted);font-size:13px}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="app">
    <h1>Apartment Purchase Tracker</h1>
    <p class="lead">The <strong>highlighted person</strong> is the one who needs to buy the item next. Click "Mark as bought" when they buy it.</p>

    <div id="items" class="items"></div>

    <footer>Data stored in your Google Sheet. Everyone using this page will see the same state.</footer>
  </div>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyIwz9SfcHIHn_I5Z3hSdENS7R0ov6pTmjXfYWuDFAD0eQXloVQRUyGCUcQCtGPJDGW/exec'; // replace with your Apps Script URL

    async function apiGet() {
      const res = await fetch(API_BASE);
      if (!res.ok) throw new Error('Failed to load from sheet');
      return res.json();
    }

    async function apiPost(itemName, newIndex) {
      const res = await fetch(API_BASE, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({item: itemName, index: newIndex})
      });
      if (!res.ok) throw new Error('Failed to save to sheet');
      return res.json();
    }

    function el(tag, props={}, ...children){
      const n = document.createElement(tag);
      for (const k in props) {
        if (k === 'class') n.className = props[k];
        else if (k.startsWith('on')) n.addEventListener(k.slice(2), props[k]);
        else n.setAttribute(k, props[k]);
      }
      for (const c of children) if (c) n.append(typeof c === 'string' ? document.createTextNode(c) : c);
      return n;
    }

    async function loadAndRender(){
      const container = document.getElementById('items');
      let items;
      try{ 
        items = await apiGet(); 
      }catch(e){ 
        container.innerHTML = '';
        container.appendChild(el('div',{class:'card'}, el('div',{}, 'Could not load data — check your Apps Script deployment.')));
        return;
      }

      const fragment = document.createDocumentFragment();

      items.forEach(it => {
        const card = el('div',{class:'card'});
        const head = el('div',{class:'item-head'}, el('div',{class:'item-name'}, it.item));

        const cycle = Array.isArray(it.cycle) ? it.cycle : it.cycle.split(',');
        const idx = Number(it.index) || 0;

        const namesRow = el('div',{class:'names'});
        cycle.forEach((n,i)=>{
          const cls = 'name' + (i===idx ? ' current' : '');
          namesRow.appendChild(el('div',{class:cls}, n));
        });

        const btn = el('button',{class:'chk', onclick: async ()=>{
          const next = (idx + 1) % cycle.length;
          btn.disabled = true; btn.textContent = 'Saving...';
          try{
            await apiPost(it.item, next);
            setTimeout(loadAndRender, 500);
          }catch(err){
            alert('Save failed — try again.');
            btn.disabled = false; btn.textContent = 'Mark as bought';
          }
        }}, 'Mark as bought');

        const meta = el('div',{class:'meta small'}, 'Next buyer: ' + (cycle[idx] || '—'));

        head.appendChild(el('div',{}, btn));
        card.appendChild(head);
        card.appendChild(namesRow);
        card.appendChild(meta);

        fragment.appendChild(card);
      });

      container.innerHTML = '';
      container.appendChild(fragment);
    }

    loadAndRender();
    setInterval(loadAndRender, 12000);
  </script>
</body>
</html>
